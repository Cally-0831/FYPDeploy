<div class="Pagetitle">This is TimeTable Submission Page</div>
<br><br>
<form action="/timetable/submitttb" method="post" onsubmit="submitform(this);return false;">
    <br>
    <div id="allclassinputfield" style="font-size: 20px;">
        <div id="singleclassinfo" class="singleclassinfo">

            <div id="deptinputfield" class="singleclassinfocontent">
                <label for="classdep">Please input your class's department code&nbsp;:&nbsp;</label>
                <select name="classdep" id="classdep">
                    <option value="">---Please Select---</option>

                    <%allDeptlist.forEach( function(list) { %>
                        <option value="<%=list.CDept%>">
                            <%=list.CDept%>
                        </option>
                        <% })%>
                </select>
            </div>
            <div id="codeinputfield" class="singleclassinfocontent">
                <label for="classcode">Please input your class's code&nbsp;:&nbsp;</label>
                <select name="classcode" id="classcode">
                    <option value="">---Please Select---</option>

                </select>
            </div>
            <div id="sectioninputfield" class="singleclassinfocontent">
                <label for="classsection">Please input your class's section code&nbsp;:&nbsp;</label>
                <select name="classsection" id="classsection">
                    <option value="">---Please Select---</option>
                </select>
            </div>
            <div id="labsectioninputfield" class="singleclassinfocontent">

            </div>
            <button class="buttonlogout" type="submit is-success" >Add Class</button>

        </div>
</form>

<script>
     async function submitform(formElem) {
        
        if(document.getElementById("classdep").value == ""){
            return alert("Department Code cannot be empty")
        }else if(document.getElementById("classcode").value == ""){
            return alert("Class Code cannot be empty")
        }else if(document.getElementById("classsection").value == ""){
            return alert("Class Section Code cannot be empty")
        }else if(document.getElementById("classlabsection") !=null &&  document.getElementById("classlabsection").value == ""){
            return alert("Class Tutorial Section Code cannot be empty")
        }

        try {
            var response = await fetch(formElem.action, {
                method: formElem.method,
                body: new FormData(formElem),
            });
            if (response.ok) {
                
                location.assign("/timetable");

            } else if (response.status == 401) {
                var msg = await response.json();
                alert(msg);
            } else {
                alert(response.statusTest);
            }

        } catch (error) {
            console.log(error);
        }
     }

    function _(element) {
        return document.getElementById(element);
    }

    function fetch_data(parent_element, child_element, type) {
        fetch("/timetable/submitttb/get_data?type=" + type + "&parent_value=" + parent_element + "").then(function (response) {
            return response.json();
        }).then(function (responseData) {

            var html = "";

            if (type == "load_code") {
                html = "\<option value=\"\"\>---Please Select---</option\>";
                for (var i = 0; i < responseData.length; i++) {
                    html += "<option value=\"" + responseData[i].CCode + "\">" + responseData[i].CCode + "</option>";
                }
            }

            if (type == "load_section") {
                html = "\<option value=\"\"\>---Please Select---</option\>";
                for (var i = 0; i < responseData.length; i++) {
                    html += "<option value=\"" + responseData[i].CSecCode + "\">" + responseData[i].CSecCode + "</option>";
                }
            }

            if (type == "load_lab" && responseData.length > 0) {
                html = "<label for=\"classlabsection\">Please input your class's tutorial section code&nbsp;:&nbsp;</label\>"
                    + "<select name=\"classlabsection\" id=\"classlabsection\"\>"
                    + "\<option value=\"\"\>---Please Select---</option\>"
                for (var i = 0; i < responseData.length; i++) {
                    html += "<option value=\"" + responseData[i].CSecCode + "\">" + responseData[i].CSecCode + "</option>";
                }
                html += "</select\>"
            }

            document.getElementById(child_element).innerHTML = html;
        });
    }

    _("classdep").onchange = function () {
        document.getElementById("classcode").value = "";
        document.getElementById("classsection").value = "";
        if (document.getElementById("classlabsection") != null) {
            document.getElementById("classlabsection").value = "";
        }

        fetch_data(document.getElementById("classdep").value, "classcode", "load_code");
    };

    _("classcode").onchange = function () {
        document.getElementById("classsection").value = "";
        if (document.getElementById("classlabsection") != null) {
            document.getElementById("classlabsection").value = "";
        }
        fetch_data(document.getElementById("classdep").value + "" + document.getElementById("classcode").value, "classsection", "load_section");
    };
    _("classsection").onchange = function () {
        if (document.getElementById("classlabsection") != null) {
            document.getElementById("classlabsection").value = "";
        }
        fetch_data(document.getElementById("classdep").value + "" + document.getElementById("classcode").value + "_" + document.getElementById("classsection").value, "labsectioninputfield", "load_lab");
    };


</script>