
<% if(allpersonallist == null || allpersonallist == undefined){return res.view('/user/login')}%>
<% if(allpersonallist.length ==0 || allpersonallist[0].confirmation == 0){%>
    <div class="Pagetitle">
        <%=req.session.username%>'s TimeTable
    </div>
    <div>
        <div class="buttons is-left">
            <button class="button buttonlogout" onclick="history.back()">Back</button>
        </div>
        <div class="buttons is-right">
                    <a href="/timetable/submitttb">
                        <button class="button buttonlogout" id="addclass">Add Class</button>
                    </a>
                    <% if(req.session.role=="stu"){%>
                        <br>
                        <br>
                        <form method="post"  action="/timetable" onsubmit="submitform(this);return false;">
                            <label for="studentttbpic">Timetable Proof:&emsp;&emsp;&emsp;</label>
                            <input
                            type="file"
                            id="studentttbpic"
                            name="studentttbpic"
                            accept=".png ,.jpg ,.jpeg"
                            onchange="getFileData(this)" /> 
                            <div id="appearthebutton" ></div>
                          </form>
                          <br><br><Br>
                           
                    <%}else{%>
                            <button class="button buttonlogout" onclick="Submitthisttb()">Submit Timetable</button>
                            <br>
                    <%}%>
                    <br> <br> 
    </div>
                
                
           
        
<%}else{%>
        
        <div class="Pagetitle">
            <%=req.session.username%>'s Submitted TimeTable
        </div>
        <br>
        <div class="rows">
            <div class="row">
              <div class="columns is-mobile">
                <div class="column is-half">
                  <div class="buttons is-left">
                    <div class="button buttonlogout " onclick="history.back()">
                      Back
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
                <% var submitteddate = new Date(allpersonallist[0].Submissiontime)%>
            Submitted at <%=submitteddate%>
            </div>
         </div>
        <%}%>      
    



    
    



<br>


<br><br>
<table class="table is-bordered is-striped is-hoverable is-fullwidth text-center">
    <th style="font-size:20px;text-align: center;vertical-align:center;">Class Code</th>
    <th style="font-size:20px;text-align: center;vertical-align:center;">Class Section</th>
    <th style="font-size:20px;text-align: center;vertical-align:center;">Action</th>

    <% allpersonallist.forEach(function(list){ var stringstring=list.CID.split("_"); %>
        <tr>
            <%if(stringstring.length < 3){%>
                <td style="font-size:20px;text-align: center;vertical-align:center;">
                <%=stringstring[0]%>
            </td>
            <td style="font-size:20px;text-align: center;vertical-align:center;">
                <%=stringstring[1]%>
            </td>   
            <td style="font-size:20px;text-align: center;vertical-align:center;">
                <button class="button" type="button"
                onclick="deleteclassinput('<%=stringstring[0]%>','<%=stringstring[1]%>')">Delete</button>
            </td>              
                <%} %>
            
        </tr>
        <%})%>

</table>
<br><Br><br>
<table class="table is-bordered is-striped is-hoverable is-halfwidth center">
    <th class="th"></th>
    <th class="th">MON</th>
    <th class="th">TUE</th>
    <th class="th">WED</th>
    <th class="th">THU</th>
    <th class="th">FRI</th>
    <th class="th">SAT</th>

    <tr>
        <td style="font-size:20px;text-align: center;vertical-align:center;">08:30</td>
        <% 
        var lastbox;
        var arraylist = new Array(6);
        for(var i=0 ; i < allpersonallist.length;i++){ 

            var cidstr = allpersonallist[i].CID.split("_");
            allpersonallist[i].CID = cidstr[0]+"_"+cidstr[1];
           
            let currenttime =new Date();
            currenttime.setHours(8, 30, 0, 0); 
            
            
            let endend=new Date();
            endend.setHours(9,20,0,0) 
            
            let classend=new Date(); const
            classendstr=(allpersonallist[i].endTime).split(":"); 
            classend.setHours(classendstr[0],classendstr[1],classendstr[2],0)
            

            let classstart=new Date(); 
            const classstartstr=(allpersonallist[i].startTime).split(":"); 
            classstart.setHours(classstartstr[0],classstartstr[1],classstartstr[2],0)

           
           if(classstart.toLocaleString("en-GB") == currenttime.toLocaleString("en-GB") ){
            arraylist[allpersonallist[i].weekdays -1] = allpersonallist[i];
        
           }

           if(classstart < currenttime && classend >=endend){
            arraylist[allpersonallist[i].weekdays -1] = allpersonallist[i];
           }
           
          
        }for(var x = 0 ; x < 6;x++){
            if(arraylist[x]!= undefined && x == arraylist[x].weekdays-1){%>
<td style="font-size:20px;text-align: center;vertical-align:center;"><%=arraylist[x].CID%></td>
           <% }else{%>
            <td style="font-size:20px;text-align: center;vertical-align:center;"></td><%}
           }
           arraylist = new Array(6);
           %>
             
                        

    </tr>
    <tr>
        <td style="font-size:20px;text-align: center;vertical-align:center;">09:30</td>
        <% 
        var lastbox;
        var arraylist = new Array(6);
        for(var i=0 ; i < allpersonallist.length;i++){ 
          
            var cidstr = allpersonallist[i].CID.split("_");
            allpersonallist[i].CID = cidstr[0]+"_"+cidstr[1];

            let currenttime =new Date();
            currenttime.setHours(9, 30, 0, 0); 
            
            
            let endend=new Date();
            endend.setHours(10,20,0,0) 
            
            let classend=new Date(); const
            classendstr=(allpersonallist[i].endTime).split(":"); 
            classend.setHours(classendstr[0],classendstr[1],classendstr[2],0)
            

            let classstart=new Date(); 
            const classstartstr=(allpersonallist[i].startTime).split(":"); 
            classstart.setHours(classstartstr[0],classstartstr[1],classstartstr[2],0)

           
          
           if(classstart.toLocaleString("en-GB") == currenttime.toLocaleString("en-GB") ){
            arraylist[allpersonallist[i].weekdays -1] = allpersonallist[i];
        
           }

           if(classstart < currenttime && classend >=endend){
            arraylist[allpersonallist[i].weekdays -1] = allpersonallist[i];
           }

           
        }for(var x = 0 ; x < 6;x++){
            if(arraylist[x]!= undefined && x == arraylist[x].weekdays-1){%>
<td style="font-size:20px;text-align: center;vertical-align:center;"><%=arraylist[x].CID%></td>
           <% }else{%>
            <td style="font-size:20px;text-align: center;vertical-align:center;"></td><%}
           }arraylist = new Array(6);%>

    </tr>
    <tr>
        <td style="font-size:20px;text-align: center;vertical-align:center;">10:30</td>
        <% 
        var lastbox;
        var arraylist = new Array(6);
        for(var i=0 ; i < allpersonallist.length;i++){ 
          
            var cidstr = allpersonallist[i].CID.split("_");
            allpersonallist[i].CID = cidstr[0]+"_"+cidstr[1];

            let currenttime =new Date();
            currenttime.setHours(10, 30, 0, 0); 
            
            
            let endend=new Date();
            endend.setHours(11,20,0,0) 
            
            let classend=new Date(); const
            classendstr=(allpersonallist[i].endTime).split(":"); 
            classend.setHours(classendstr[0],classendstr[1],classendstr[2],0)
            

            let classstart=new Date(); 
            const classstartstr=(allpersonallist[i].startTime).split(":"); 
            classstart.setHours(classstartstr[0],classstartstr[1],classstartstr[2],0)

             
           if(classstart.toLocaleString("en-GB") == currenttime.toLocaleString("en-GB") ){
            arraylist[allpersonallist[i].weekdays -1] = allpersonallist[i];
        
           }

           if(classstart < currenttime && classend >=endend){
            arraylist[allpersonallist[i].weekdays -1] = allpersonallist[i];
           }
           
        }for(var x = 0 ; x < 6;x++){
            if(arraylist[x]!= undefined && x == arraylist[x].weekdays-1){%>
<td style="font-size:20px;text-align: center;vertical-align:center;"><%=arraylist[x].CID%></td>
           <% }else{%>
            <td style="font-size:20px;text-align: center;vertical-align:center;"></td><%}
           }
           arraylist = new Array(6);
           %>
    </tr>
    <tr>
        <td style="font-size:20px;text-align: center;vertical-align:center;">11:30</td>
        <% 
        var lastbox;
        var arraylist = new Array(6);
        for(var i=0 ; i < allpersonallist.length;i++){ 
             var cidstr = allpersonallist[i].CID.split("_");
            allpersonallist[i].CID = cidstr[0]+"_"+cidstr[1];

            let currenttime =new Date();
            currenttime.setHours(11, 30, 0, 0); 
            
            
            let endend=new Date();
            endend.setHours(12,20,0,0) 
            
            let classend=new Date(); const
            classendstr=(allpersonallist[i].endTime).split(":"); 
            classend.setHours(classendstr[0],classendstr[1],classendstr[2],0)
            

            let classstart=new Date(); 
            const classstartstr=(allpersonallist[i].startTime).split(":"); 
            classstart.setHours(classstartstr[0],classstartstr[1],classstartstr[2],0)

            
           if(classstart.toLocaleString("en-GB") == currenttime.toLocaleString("en-GB") ){
            arraylist[allpersonallist[i].weekdays -1] = allpersonallist[i];
        
           }

           if(classstart < currenttime && classend >=endend){
            arraylist[allpersonallist[i].weekdays -1] = allpersonallist[i];
           }
           
        }for(var x = 0 ; x < 6;x++){
            if(arraylist[x]!= undefined && x == arraylist[x].weekdays-1){%>
<td style="font-size:20px;text-align: center;vertical-align:center;"><%=arraylist[x].CID%></td>
           <% }else{%>
            <td style="font-size:20px;text-align: center;vertical-align:center;"></td><%}
           }
           arraylist = new Array(6);
           %>
    </tr>
    <tr>
        <td style="font-size:20px;text-align: center;vertical-align:center;">12:30</td>
        <% 
        var lastbox;
        var arraylist = new Array(6);
        for(var i=0 ; i < allpersonallist.length;i++){ 
            var cidstr = allpersonallist[i].CID.split("_");
            allpersonallist[i].CID = cidstr[0]+"_"+cidstr[1];

            let currenttime =new Date();
            currenttime.setHours(12, 30, 0, 0); 
            
            
            let endend=new Date();
            endend.setHours(13,20,0,0) 
            
            let classend=new Date(); const
            classendstr=(allpersonallist[i].endTime).split(":"); 
            classend.setHours(classendstr[0],classendstr[1],classendstr[2],0)
            

            let classstart=new Date(); 
            const classstartstr=(allpersonallist[i].startTime).split(":"); 
            classstart.setHours(classstartstr[0],classstartstr[1],classstartstr[2],0)

            
          
           if(classstart.toLocaleString("en-GB") == currenttime.toLocaleString("en-GB") ){
            arraylist[allpersonallist[i].weekdays -1] = allpersonallist[i];
        
           }

           if(classstart < currenttime && classend >=endend){
            arraylist[allpersonallist[i].weekdays -1] = allpersonallist[i];
           }

           
        }for(var x = 0 ; x < 6;x++){
            if(arraylist[x]!= undefined && x == arraylist[x].weekdays-1){%>
<td style="font-size:20px;text-align: center;vertical-align:center;"><%=arraylist[x].CID%></td>
           <% }else{%>
            <td style="font-size:20px;text-align: center;vertical-align:center;"></td><%}
           }
           arraylist = new Array(6);
           %>
    </tr>
    <tr>
        <td style="font-size:20px;text-align: center;vertical-align:center;">13:30</td>
        <% 
        var lastbox;
        var arraylist = new Array(6);
        for(var i=0 ; i < allpersonallist.length;i++){ 
             var cidstr = allpersonallist[i].CID.split("_");
            allpersonallist[i].CID = cidstr[0]+"_"+cidstr[1];

            let currenttime =new Date();
            currenttime.setHours(13, 30, 0, 0); 
            
            
            let endend=new Date();
            endend.setHours(14,20,0,0) 
            
            let classend=new Date(); const
            classendstr=(allpersonallist[i].endTime).split(":"); 
            classend.setHours(classendstr[0],classendstr[1],classendstr[2],0)
            

            let classstart=new Date(); 
            const classstartstr=(allpersonallist[i].startTime).split(":"); 
            classstart.setHours(classstartstr[0],classstartstr[1],classstartstr[2],0)

            
           if(classstart.toLocaleString("en-GB") == currenttime.toLocaleString("en-GB") ){
            arraylist[allpersonallist[i].weekdays -1] = allpersonallist[i];
        
           }

           if(classstart < currenttime && classend >=endend){
            arraylist[allpersonallist[i].weekdays -1] = allpersonallist[i];
           }

           
        }for(var x = 0 ; x < 6;x++){
            if(arraylist[x]!= undefined && x == arraylist[x].weekdays-1){%>
<td style="font-size:20px;text-align: center;vertical-align:center;"><%=arraylist[x].CID%></td>
           <% }else{%>
            <td style="font-size:20px;text-align: center;vertical-align:center;"></td><%}
           }
           arraylist = new Array(6);
           %>
    </tr>
    <tr>
        <td style="font-size:20px;text-align: center;vertical-align:center;">14:30</td>
        <% 
        var lastbox;
        var arraylist = new Array(6);
        for(var i=0 ; i < allpersonallist.length;i++){ 
            
            var cidstr = allpersonallist[i].CID.split("_");
            allpersonallist[i].CID = cidstr[0]+"_"+cidstr[1];

            let currenttime =new Date();
            currenttime.setHours(14, 30, 0, 0); 
            
            
            let endend=new Date();
            endend.setHours(15,20,0,0) 
            
            let classend=new Date(); const
            classendstr=(allpersonallist[i].endTime).split(":"); 
            classend.setHours(classendstr[0],classendstr[1],classendstr[2],0)
            

            let classstart=new Date(); 
            const classstartstr=(allpersonallist[i].startTime).split(":"); 
            classstart.setHours(classstartstr[0],classstartstr[1],classstartstr[2],0)
 
           if(classstart.toLocaleString("en-GB") == currenttime.toLocaleString("en-GB") ){
            arraylist[allpersonallist[i].weekdays -1] = allpersonallist[i];
        
           }

           if(classstart < currenttime && classend >=endend){
            arraylist[allpersonallist[i].weekdays -1] = allpersonallist[i];
           }

           
        }for(var x = 0 ; x < 6;x++){
            if(arraylist[x]!= undefined && x == arraylist[x].weekdays-1){%>
<td style="font-size:20px;text-align: center;vertical-align:center;"><%=arraylist[x].CID%></td>
           <% }else{%>
            <td style="font-size:20px;text-align: center;vertical-align:center;"></td><%}
           }
           arraylist = new Array(6);
           %>
    </tr>
    <tr>
        <td style="font-size:20px;text-align: center;vertical-align:center;">15:30</td>
        <% 
        var arraylist = new Array(6);
        for(var i=0 ; i < allpersonallist.length;i++){ 
          
            var cidstr = allpersonallist[i].CID.split("_");
            allpersonallist[i].CID = cidstr[0]+"_"+cidstr[1];

            let currenttime =new Date();
            currenttime.setHours(15, 30, 0, 0); 
            
            
            let endend=new Date();
            endend.setHours(16,20,0,0) 
            
            let classend=new Date(); const
            classendstr=(allpersonallist[i].endTime).split(":"); 
            classend.setHours(classendstr[0],classendstr[1],classendstr[2],0)
            

            let classstart=new Date(); 
            const classstartstr=(allpersonallist[i].startTime).split(":"); 
            classstart.setHours(classstartstr[0],classstartstr[1],classstartstr[2],0)

            
           if(classstart.toLocaleString("en-GB") == currenttime.toLocaleString("en-GB") ){
            arraylist[allpersonallist[i].weekdays -1] = allpersonallist[i];
        
           }

           if(classstart < currenttime && classend >=endend){
            arraylist[allpersonallist[i].weekdays -1] = allpersonallist[i];
           }
           
        }for(var x = 0 ; x < 6;x++){
            if(arraylist[x]!= undefined && x == arraylist[x].weekdays-1){%>
<td style="font-size:20px;text-align: center;vertical-align:center;"><%=arraylist[x].CID%></td>
           <% }else{%>
            <td style="font-size:20px;text-align: center;vertical-align:center;"></td><%}
           }
           arraylist = new Array(6);
           %>
    </tr>
    <tr>
        <td style="font-size:20px;text-align: center;vertical-align:center;">16:30</td>
        <% 
        var lastbox;
        var arraylist = new Array(6);
        for(var i=0 ; i < allpersonallist.length;i++){ 
            var cidstr = allpersonallist[i].CID.split("_");
            allpersonallist[i].CID = cidstr[0]+"_"+cidstr[1];

            let currenttime =new Date();
            currenttime.setHours(16, 30, 0, 0); 
            
            
            let endend=new Date();
            endend.setHours(17,20,0,0) 
            
            let classend=new Date(); const
            classendstr=(allpersonallist[i].endTime).split(":"); 
            classend.setHours(classendstr[0],classendstr[1],classendstr[2],0)
            

            let classstart=new Date(); 
            const classstartstr=(allpersonallist[i].startTime).split(":"); 
            classstart.setHours(classstartstr[0],classstartstr[1],classstartstr[2],0)

          
           if(classstart.toLocaleString("en-GB") == currenttime.toLocaleString("en-GB") ){
            arraylist[allpersonallist[i].weekdays -1] = allpersonallist[i];
        
           }

           if(classstart < currenttime && classend >=endend){
            arraylist[allpersonallist[i].weekdays -1] = allpersonallist[i];
           }

           
        }for(var x = 0 ; x < 6;x++){
            if(arraylist[x]!= undefined && x == arraylist[x].weekdays-1){%>
<td style="font-size:20px;text-align: center;vertical-align:center;"><%=arraylist[x].CID%></td>
           <% }else{%>
            <td style="font-size:20px;text-align: center;vertical-align:center;"></td><%}
           }
           arraylist = new Array(6);
           %>
    </tr>
    <tr>
        <td style="font-size:20px;text-align: center;vertical-align:center;">17:30</td>
        <% 
        var lastbox;
        var arraylist = new Array(6);
        for(var i=0 ; i < allpersonallist.length;i++){ 
            
            var cidstr = allpersonallist[i].CID.split("_");
            allpersonallist[i].CID = cidstr[0]+"_"+cidstr[1];

            let currenttime =new Date();
            currenttime.setHours(17, 30, 0, 0); 
            
            
            let endend=new Date();
            endend.setHours(18,20,0,0) 
            
            let classend=new Date(); const
            classendstr=(allpersonallist[i].endTime).split(":"); 
            classend.setHours(classendstr[0],classendstr[1],classendstr[2],0)
            

            let classstart=new Date(); 
            const classstartstr=(allpersonallist[i].startTime).split(":"); 
            classstart.setHours(classstartstr[0],classstartstr[1],classstartstr[2],0)

           if(classstart.toLocaleString("en-GB") == currenttime.toLocaleString("en-GB") ){
            arraylist[allpersonallist[i].weekdays -1] = allpersonallist[i];
        
           }

           if(classstart < currenttime && classend >=endend){
            arraylist[allpersonallist[i].weekdays -1] = allpersonallist[i];
           }

           
        }for(var x = 0 ; x < 6;x++){
            if(arraylist[x]!= undefined && x == arraylist[x].weekdays-1){%>
<td style="font-size:20px;text-align: center;vertical-align:center;"><%=arraylist[x].CID%></td>
           <% }else{%>
            <td style="font-size:20px;text-align: center;vertical-align:center;"></td><%}
           }
           arraylist = new Array(6);
           %>
    </tr>
    <tr>
        <td style="font-size:20px;text-align: center;vertical-align:center;">18:30</td>
        <% 
        var lastbox;
        var arraylist = new Array(6);
        for(var i=0 ; i < allpersonallist.length;i++){ 
           
  
            var cidstr = allpersonallist[i].CID.split("_");
            allpersonallist[i].CID = cidstr[0]+"_"+cidstr[1];


            let currenttime =new Date();
            currenttime.setHours(18, 30, 0, 0); 
            
            
            let endend=new Date();
            endend.setHours(19,20,0,0) 
            
            let classend=new Date(); const
            classendstr=(allpersonallist[i].endTime).split(":"); 
            classend.setHours(classendstr[0],classendstr[1],classendstr[2],0)
            

            let classstart=new Date(); 
            const classstartstr=(allpersonallist[i].startTime).split(":"); 
            classstart.setHours(classstartstr[0],classstartstr[1],classstartstr[2],0)

           if(classstart.toLocaleString("en-GB") == currenttime.toLocaleString("en-GB") ){
            arraylist[allpersonallist[i].weekdays -1] = allpersonallist[i];
        
           }

           if(classstart < currenttime && classend >=endend){
            arraylist[allpersonallist[i].weekdays -1] = allpersonallist[i];
           }
           
        }for(var x = 0 ; x < 6;x++){
            if(arraylist[x]!= undefined && x == arraylist[x].weekdays-1){%>
<td style="font-size:20px;text-align: center;vertical-align:center;"><%=arraylist[x].CID%></td>
           <% }else{%>
            <td style="font-size:20px;text-align: center;vertical-align:center;"></td><%}
           }
           arraylist = new Array(6);
           %>
    </tr>
</table>

<script>


var thisfile;
   
function getFileData(myFile){

    var file = myFile.files[0];
    thisfile = file;
    filedata = file;
    var filename = file.name;
   var filetype = (file.name.split("."))[1]
   
   if(filetype != "png" && filetype != "jpg" && filetype != "jpeg")
   {
    document.getElementById("studentttbpic").value ="";
    return alert("Please Upload a correct format of proof");
   }else{
    document.getElementById("appearthebutton").innerHTML = "<br><button class=\"buttonlogout\" type=\"submit is-success\">Submit Timetable</button>";
   
   }
}

async function submitform(formElem){
 
    var file = thisfile;
    var filedata;
    var filename = file.name;
   var filetype = (file.name.split("."))[1]
   
   var reader = new FileReader();
  reader.onloadend = async function() {
    //console.log('Encoded Base 64 File String:', reader.result);
    
    /******************* for Binary ***********************/
    //var data=(reader.result).split(',')[1];
    // var binaryBlob = atob(data);
    var data = reader.result
    filedata =  data;
     //console.log('Encoded Binary File String:', filedata);
  

var requestBody;
    var r = confirm("This is student button\n\nConfirm to Upload This Timetable? \n\n Once the Timetable has been uploaded to the System,\n the timetable cannot be modified.");
 if(filedata!= null || filedata!= undefined){
   requestBody= JSON.stringify({
    fileorg : thisfile,
           filedata: filedata
        });
 }
    if(r){
        console.log("enterhere2")
    var response = await fetch(formElem.action, {
                method: "POST",
                body:   requestBody
            });

            if (response.ok) {
                alert(" Your Timetable submitted.");
                location.reload();
            } else {
                alert(response.status + ": " + response.statusText);
            }

}
}
  reader.readAsDataURL(file);
}

async function Submitthisttb(){
    
   
    var r = confirm("Confirm to Upload This Timetable? \n Once the Timetable has been uploaded to the System,\n the timetable cannot be modified.");
if(r){
    
    var response = await fetch("/timetable", {
                method: "POST",
                
            });

            if (response.ok) {
               
                alert("Timetable submitted.");
                location.reload();
            } else {
                alert(response.status + ": " + response.statusText);
            }

}else{

}
}
async function deleteclassinput(ccode,cseccode) {
        var r = confirm("Confirm Delete " + ccode +"_"+cseccode+ " ?");
        var requestBody = JSON.stringify({ cid:  ccode +"_"+cseccode });
        if (r) {

            var response = await fetch("/timetable", {
                method: "DELETE",
                body: requestBody
            });

            if (response.ok) {
                // var html = await response.text();
                // alert(html);

                alert("Class input deleted.");
                location.assign("/timetable");
            } else {
                alert(response.status + ": " + response.statusText);
            }

        } else {
            alert("cancelled");
        }
    };
</script>